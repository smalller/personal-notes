[toc]
## Object变化侦测
1. 通过Object.defineProperty方法实现对object数据的可观测
2. 封装Observer类，能够把object数据中的所有属性（包括子属性）都转换成getter/seter的形式来侦测变化
3. 在getter中收集依赖，在setter中通知依赖更新，以及封装依赖管理器Dep，用于存储收集到的依赖
4. 为每一个依赖都创建一个Watcher实例，当数据发生变化时，通知Watcher实例，由Watcher实例去做真实的更新操作

流程：
1. Data通过observer转换成了getter/setter的形式来追踪变化
2. 当外界通过Watcher读取数据时，会触发getter从而将Watcher添加到依赖中
3. 当数据发生了变化时，会触发setter，从而向Dep中的依赖（即Watcher）发送通知
4. Watcher接收到通知后，会向外界发送通知，变化通知到外界后可能会触发视图更新，也有可能触发用户的某个回调函数等

## Array变化侦测
1. 在Vue中创建了一个数组方法拦截器，它拦截在数组实例与Array.prototype之间，在拦截器内重写了操作数组的一些方法，当数组实例使用操作数组方法时，其实使用的是拦截器中重写的方法，而不再使用Array.prototype上的原生方法

## VNode的作用
1. 在视图渲染之前，把写好的template模板先编译成VNode并缓存下来
2. 等到数据发生变化页面需要重新渲染的时候，通过diff算法，把数据发生变化后生成的VNode与前一次缓存下来的VNode进行对比，找出差异，然后有差异的VNode对应的真实DOM节点就是需要重新渲染的节点
3. 最后根据有差异的VNode创建出真实的DOM节点再插入到视图中，最终完成一次视图更新

## DOM-Diff算法（patch打补丁过程）
- 创建节点：新的VNode中有而旧的oldVNode中没有，就在旧的oldVNode中创建
- 删除节点：新的VNode中没有而旧的oldVNode中有，就从旧的oldVNode中删除
- 更新节点：新的VNode和旧的oldVNode中都有，就以新的VNode为准，更新旧的oldVNode
Vue为了避免双重循环数据量大时间复杂度升高带来的性能问题，而选择了从子节点数组中的4个特殊位置互相比对，分别是：新前与旧前，新后与旧后，新后与旧前，新前与旧后

更新节点流程图如下：
![更新节点流程图](https://vue-js.com/learn-vue/assets/img/3.7b0442aa.png)

## 模板编译
### 抽象语法树AST
1. 模板解析阶段：将一堆模板字符串用正则等方式解析成抽象语法树AST
2. 优化阶段：遍历AST，找出其中的静态节点，并打上标记
3. 代码生成阶段：将AST转换成渲染函数
### 模板解析阶段
HTML解析器是主线，先用HTML解析器进行解析整个模板，在解析过程中如果碰到文本内容，那就调用文本解析器来解析文本，如果碰到文本中包含过滤器那就调用过滤器解析器来解析
### HTML解析器
有4个钩子函数作为参数传给解析器parseHTML，当解析器解析出不同的内容时调用不同的钩子函数从而生成不同的AST
- 当解析到开始标签时调用start函数生成元素类型的AST节点
- 当解析到结束标签时调用end函数
- 当解析到文本时调用chars函数生成文本类型的AST节点
- 当解析到注释时调用comment函数生成注释类型的AST节点

一边解析不同的内容一边调用对应的钩子函数生成对应的AST节点，最终完成将整个模板字符串转化成AST,这就是HTML解析器所要做的工作

### 文本解析器
当Vue用HTML解析器解析出文本时，再将解析出来的文本内容传给文本解析器，最后由文本解析器解析该段文本里面是否包含变量以及如果包含变量时再做其他操作，为后续的render做准备

### 优化阶段
- 在AST中找出所有静态节点并打上标记
- 在AST中找出所有静态根节点并打上标记

该阶段是为了提高虚拟DOM中patch过程的性能。在优化阶段将所有静态节点都打上标记，这样在patch过程中就可以跳过对比这些节点

### 代码生成阶段
代码生成其实就是根据模板对应的抽象语法树AST生成一个函数供组件挂载时调用，通过调用这个函数就可以得到模板对应的虚拟DOM
- 首先从Vue实例的属性选项中获取render选项，如果没有获取到，说明用户没有手写render函数，需要Vue自己将模板转化成render函数
- 接着获取模板，先尝试获取内部模板，如果获取不到则获取外部模板。最后再调用render函数

## 生命周期
Vue实例的生命周期大致可分为4个阶段：
- 初始化阶段：为Vue实例上初始化一些属性，事件以及响应式数据；
- 模板编译阶段：将模板编译成渲染函数；
- 挂载阶段：将实例挂载到指定的DOM上，即将模板渲染到真实DOM中；
- 销毁阶段：将实例自身从父组件中删除，并取消依赖追踪及事件监听器；

### 初始化阶段
#### new Vue()
合并配置，调用一些初始化函数，触发生命周期钩子函数，调用$mount开启下一个阶段